<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.90.0" />
    <meta name="description" content="Official Rafay product documentation. Explore &#34;Learn KOP - Part 8 - Policy Management&#34; docs and more here. Rafay is a SaaS-first Kubernetes Operations Platform with enterprise-class scalability.">
<meta name="author" content="James Bland">

    <link rel="icon" href="https://awsmedia.s3.amazonaws.com/favicon.ico" type="image/x-icon" />

    <title>Learn KOP - Part 8 - Policy Management :: Rafay Workshop 1</title>

    
    <link href="/css/nucleus.css?1639173650" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1639173650" rel="stylesheet">
    <link href="/css/hybrid.css?1639173650" rel="stylesheet">
    <link href="/css/featherlight.min.css?1639173650" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1639173650" rel="stylesheet">
    <link href="/css/auto-complete.css?1639173650" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1639173650" rel="stylesheet">
    <link href="/css/theme.css?1639173650" rel="stylesheet">
    <link href="/css/hugo-theme.css?1639173650" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1639173650" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1639173650"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/010_intro/7_polmgmt.html">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a href="/" title="Go home"><img style="vertical-align:middle" src="https://modernization-workshop-bucket.s3-us-west-2.amazonaws.com/images/logo.png" height="70px">

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1639173650"></script>
<script type="text/javascript" src="/js/auto-complete.js?1639173650"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1639173650"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/010_intro.html" title="Learn KOP &amp; EKS - CloudWatch Overview" class="dd-item
        parent
        
        
        ">
      <a href="/010_intro.html">
          Learn KOP &amp; EKS - CloudWatch Overview
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/010_intro/1_setup.html" title="Learn KOP - Initial Setup" class="dd-item ">
        <a href="/010_intro/1_setup.html">
        Learn KOP - Initial Setup
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/2_provision.html" title="Learn KOP - Provision EKS Cluster with Amazon CloudWatch Integration" class="dd-item ">
        <a href="/010_intro/2_provision.html">
        Learn KOP - Provision EKS Cluster with Amazon CloudWatch Integration
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/3_ztka.html" title="Learn KOP - Part 3 - Zero Trust Kubectl" class="dd-item ">
        <a href="/010_intro/3_ztka.html">
        Learn KOP - Part 3 - Zero Trust Kubectl
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/4_namespaces.html" title="Learn KOP - Part 4 - Namespaces" class="dd-item ">
        <a href="/010_intro/4_namespaces.html">
        Learn KOP - Part 4 - Namespaces
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/5_blueprint.html" title="Learn KOP - Amazon CloudWatch Blueprint" class="dd-item ">
        <a href="/010_intro/5_blueprint.html">
        Learn KOP - Amazon CloudWatch Blueprint
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/6_visandmon.html" title="Learn KOP - Part 6 - Visibility and Monitoring" class="dd-item ">
        <a href="/010_intro/6_visandmon.html">
        Learn KOP - Part 6 - Visibility and Monitoring
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/7_polmgmt.html" title="Learn KOP - Part 8 - Policy Management" class="dd-item active">
        <a href="/010_intro/7_polmgmt.html">
        Learn KOP - Part 8 - Policy Management
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/8_deprov.html" title="Learn KOP - Deprovision Cluster" class="dd-item ">
        <a href="/010_intro/8_deprov.html">
        Learn KOP - Deprovision Cluster
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/010_intro/overview.html" title="Learn KOP - Overview" class="dd-item ">
        <a href="/010_intro/overview.html">
        Learn KOP - Overview
        <i class="fas fa-check read-icon"></i>
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://awsworkshop.io"><i class='fas fa-graduation-cap'></i> Rafay Workshops</a>
              </li>
          
              <li>
                  <a class="padding" href="https://aws.amazon.com/builders-library/"><i class='fas fa-tools'></i> Rafay Workshop</a>
              </li>
          
              <li>
                  <a class="padding" href="https://aws.amazon.com/blogs/modernizing-with-aws/"><i class='far fa-lightbulb'></i> KOP with AWS</a>
              </li>
          
              <li>
                  <a class="padding" href="https://eksworkshop.com/"><i class='fas fa-chalkboard-teacher'></i> EKS Workshop</a>
              </li>
          
              <li>
                  <a class="padding" href="https://ecsworkshop.com/"><i class='fas fa-chalkboard-teacher'></i> ECS Workshop</a>
              </li>
          
              <li>
                  <a class="padding" href="https://www.appmeshworkshop.com/"><i class='fas fa-chalkboard-teacher'></i> App Mesh Workshop</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      

      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>

    <a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a
        href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | <a
        href="https://modernization-workshop-bucket.s3-us-west-2.amazonaws.com/license/cc-license.html">CC BY-SA 4.0</a>

</left>
    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Rafay Multi-Cluster Management Workshop</a> > <a href='/010_intro.html'>Learn KOP & EKS - CloudWatch Overview</a> > Learn KOP - Part 8 - Policy Management
          
        
          
        
          
        
                 
                  </span>
                </div>
                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
          <div id="chapter">
        
        <div id="body-inner">
          

        




<p>This is Part 8 of a multi-part, self-paced exercise.</p>

<hr />

<h2 id="what-will-you-do">What Will You Do</h2>

<p>In this part, you will create a Kubernetes policy in your project and enforce it on all cluster in your project. You will deploy a workload out of compliance with the policy and notice that it is blocked from deployment to the cluster.</p>

<p><strong>Estimated Time</strong></p>

<p>Estimated time burden for this part is 15 minutes.</p>

<hr />

<h2 id="step-1-setup-workload">Step 1: Setup Workload</h2>

<p>One of the key benefits of using OPA Gatekeeper for policy management is that in addition to enforcing policies during &ldquo;admission&rdquo; to the Kubernetes cluster, it can also be used to determine which k8s resources &ldquo;already existing&rdquo; on the cluster are &ldquo;out of compliance&rdquo; with policy.</p>

<p>In this step, we will ensure we deploy a workload from <a href="part7.md" target="_blank">Part-7</a> with a specific number of replicas that will be out of compliance with our policy. We will use this to show how you can identify resources in violation of policy.</p>

<ul>
<li><p>Ensure that the &ldquo;replicaCount&rdquo; in the values.yaml file is set to &ldquo;2&rdquo;</p>
<pre tabindex="0"><code class="language-yaml hl_lines="5"" data-lang="yaml hl_lines="5""># Default values for webserver.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 2

nginx:
name: frontend
image:</code></pre></li>
</ul>

<p>On your cluster, when you kubectl in the workload&rsquo;s namespace, you should see something like the following.</p>
<pre tabindex="0"><code>kubectl get po -n first

NAME                                   READY   STATUS    RESTARTS   AGE
test-helm-webserver-77585694cc-29vtc   2/2     Running   11         10s
test-helm-webserver-77585694cc-qkvjd   2/2     Running   11         10s</code></pre>
<hr />

<h2 id="step-2-constraint-template">Step 2: Constraint Template</h2>

<p>You can have as many policies as you want in a Project in an Org. An OPA policy comprises one or many OPA Gatekeeper constraints. In this step, we will create a custom constrain template which will require all &ldquo;k8s deployments&rdquo; deployed on the cluster to have a &ldquo;Replica Count&rdquo; within the &ldquo;specified limit&rdquo;.</p>

<p><strong>Constraint Template</strong></p>

<ul>
<li>Save the <a href="template_min_max_pods.yaml" target="_blank">YAML File</a> on your laptop</li>
<li>In your project, navigate to OPA Gatekeeper -&gt; Constraint Templates</li>
<li>Althought a number of templates are provided out of the box, we want to create a custom template</li>
<li>Click on new template</li>
<li>Enter &ldquo;k8sreplicalimits&rdquo; and select &ldquo;upload file&rdquo; for artifact sync</li>
<li>Upload the YAML file you saved above</li>
</ul>

<p><img src="img/part8/constraint_template.png" alt="Constraint Template" /></p>

<p>!!! Important
    Ensure that the name you provide for the template matches the name in the YAML file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">templates.gatekeeper.sh/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConstraintTemplate</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">k8sreplicalimits</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">description</span>: <span style="color:#ae81ff">Requires a number of replicas to be set for a deployment between a min and max value.</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">crd</span>:
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">names</span>:
        <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">k8sreplicalimits</span>
      <span style="color:#f92672">validation</span>:
        <span style="color:#75715e"># Schema for the `parameters` field</span>
        <span style="color:#f92672">openAPIV3Schema</span>:
          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
          <span style="color:#f92672">properties</span>:
            <span style="color:#f92672">ranges</span>:
              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">array</span>
              <span style="color:#f92672">items</span>:
                <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
                <span style="color:#f92672">properties</span>:
                  <span style="color:#f92672">min_replicas</span>:
                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
                  <span style="color:#f92672">max_replicas</span>:
                    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">integer</span>
  <span style="color:#f92672">targets</span>:
    - <span style="color:#f92672">target</span>: <span style="color:#ae81ff">admission.k8s.gatekeeper.sh</span>
      <span style="color:#f92672">rego</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">        package k8sreplicalimits
</span><span style="color:#e6db74">        deployment_name = input.review.object.metadata.name
</span><span style="color:#e6db74">        violation[{&#34;msg&#34;: msg}] {
</span><span style="color:#e6db74">          spec := input.review.object.spec
</span><span style="color:#e6db74">          not input_replica_limit(spec)
</span><span style="color:#e6db74">          msg := sprintf(&#34;The provided number of replicas is not allowed for deployment: %v. Allowed ranges: %v&#34;, [deployment_name, input.parameters])
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">        input_replica_limit(spec) {
</span><span style="color:#e6db74">          provided := input.review.object.spec.replicas
</span><span style="color:#e6db74">          count(input.parameters.ranges) &gt; 0
</span><span style="color:#e6db74">          range := input.parameters.ranges[_]
</span><span style="color:#e6db74">          value_within_range(range, provided)
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">        value_within_range(range, value) {
</span><span style="color:#e6db74">          range.min_replicas &lt;= value
</span><span style="color:#e6db74">          range.max_replicas &gt;= value
</span><span style="color:#e6db74">        }</span>        </code></pre></div>
<hr />

<h2 id="step-3-constraint">Step 3: Constraint</h2>

<p>In this step, we will create a &ldquo;custom constraint&rdquo; based on the &ldquo;constraint template&rdquo; from the previous step. This constraint allows you to &ldquo;define/specify&rdquo; a MIN and MAX replicas for all deployments on your cluster.</p>

<ul>
<li>Download the <a href="constraint_mix_max_pod.yaml" target="_blank">YAML File</a> to your laptop</li>
<li>Navigate to OPA Gatekeeper -&gt; Constraints</li>
<li>Click on new constraint</li>
<li>Enter &ldquo;replica-limits&rdquo; and select &ldquo;upload file&rdquo; for artifact sync</li>
<li>Upload the YAML file you saved above</li>
</ul>

<p>!!! Important
    Ensure that the name you provide for the constraint matches the name in the YAML file</p>

<p><img src="img/part8/constraint.png" alt="Constraint" /></p>
<pre tabindex="0"><code class="language-yaml hl_lines="12 13"" data-lang="yaml hl_lines="12 13"">apiVersion: constraints.gatekeeper.sh/v1beta1
kind: k8sreplicalimits
metadata:
  name: replica-limits
spec:
  match:
    kinds:
      - apiGroups: [&#34;apps&#34;]
        kinds: [&#34;Deployment&#34;]
  parameters:
    ranges:
    - min_replicas: 3
      max_replicas: 10</code></pre>
<hr />

<h2 id="step-4-policy">Step 4: Policy</h2>

<p>A policy comprises at least one constraints (default and/or custom) and optional exclusions.</p>

<ul>
<li>Navigate to OPA Gatekeeper -&gt; Policy</li>
<li>Click on new Policy, provide a name and Save</li>
<li>Provide a version (alphanumeric is ok)</li>
<li>Select the &ldquo;replica-limits&rdquo; constraint from the dropdown and Save</li>
</ul>

<p><img src="img/part8/policy_version.png" alt="Policy" /></p>

<hr />

<h2 id="step-5-cluster-blueprint">Step 5: Cluster Blueprint</h2>

<p>In the previous step, you created a policy comprising OPA Gatekeeper constraints. Now, you will include this policy in a &ldquo;custom cluster blueprint&rdquo; and apply it to your cluster. This step will be very similar to what you did in <a href="part5.md" target="_blank">Part 5</a>.</p>

<p>!!! Important
    You can use the same cluster blueprint for multiple clusters achieving project and org wide standardization and compliance.</p>

<ul>
<li>Navigate to Infrastructure -&gt; Blueprints</li>
<li>Create a new blueprint and provide a name (e.g. opa)</li>
<li>Click on new version</li>
<li>Select &ldquo;minimal&rdquo; for base blueprint</li>
<li>Select &ldquo;Enable OPA Gatekeeper&rdquo;, select the &ldquo;OPA policy&rdquo; and version we created in the previous step and Sav</li>
</ul>

<p><img src="img/part8/opa_blueprint.png" alt="OPA Blueprint" /></p>

<p>Navigate to your cluster and apply the &ldquo;OPA&rdquo; custom cluster blueprint on the cluster. In a few minutes, all required components for OPA Gatekeeper and the constraints will become operational on your cluster.</p>

<p><img src="img/part8/opa_bp_cluster.png" alt="OPA Blueprint" /></p>

<p>Optionally, you can also use kubectl to look at the OPA gatekeeper resources on the cluster</p>
<pre tabindex="0"><code class="language-yaml hl_lines="6 7 8 9"" data-lang="yaml hl_lines="6 7 8 9"">kubectl get po -n rafay-system

NAME                                             READY   STATUS    RESTARTS   AGE
controller-manager-868759489b-f6xpg              1/1     Running   30         35h
edge-client-75d456497-78tqp                      1/1     Running   1          35h
gatekeeper-audit-69d75d695c-rwnnd                1/1     Running   0          28h
gatekeeper-controller-manager-59fb975495-rvnks   1/1     Running   0          25s
gatekeeper-controller-manager-59fb975495-x2fpw   1/1     Running   0          25s
gatekeeper-controller-manager-59fb975495-zj5dg   1/1     Running   0          25s
rafay-connector-6c6c4f67cf-m5c6n                 1/1     Running   44         35h
relay-agent-7bb69f58c4-5chgc                     1/1     Running   1          35h
velero-dk6wpm1-desktop-55f57589ff-x6nf8          1/1     Running   0          23h</code></pre>
<p>To check if the OPA gatekeeper &ldquo;constraints&rdquo; we specified in the policy are operational on the cluster. As you can see from the results, OPA Gatekeeper was automatically deployed to the cluster with configuration from the policy we specified.</p>
<pre tabindex="0"><code>kubectl get constraints

NAME             AGE
replica-limits   5m</code></pre>
<hr />

<h2 id="step-6-policy-violations">Step 6: Policy Violations</h2>

<ul>
<li>Navigate to Home -&gt; System -&gt; Audit Logs</li>
<li>Select the OPA tab</li>
<li>Select the project and your cluster name (e.g. desktop project, desktop cluster)</li>
</ul>

<p>This will perform a real time retrieval of &ldquo;policy violations&rdquo; already existing on the selected cluster and display the results to the administrator. In our example, we can see that it is reporting that our pre-existing workload has deployments that violate our policy. A logical approach will be for security administrators to work with the workload owners to remediate the violations.</p>

<p><img src="img/part8/policy_violations.png" alt="OPA Violations" /></p>

<hr />

<h2 id="step-7-new-deployments">Step 7: New Deployments</h2>

<p>In this step, we will see what workload owners will experience if they try to deploy a new workload or update an existing workload that is not in compliance with the configured policy in the cluster blueprint.</p>

<ul>
<li>Navigate to your Git repo and update the &ldquo;replicaCount&rdquo; in the values.yaml file to &ldquo;1&rdquo;</li>
<li>The GitOps pipeline will pick up the changes and attempt to deploy to the remote cluster</li>
<li>The pipeline job will fail because the specs are &ldquo;not in compliance&rdquo; with the configured policy. Workload owners will be presented with a friendly error message as in the example shown below.</li>
</ul>

<p><img src="img/part8/gitops_failed.png" alt="GitOps Pipeline Failed" /></p>

<hr />

<h2 id="recap">Recap</h2>

<p>Congratulations! At this point, you have successfully created a policy and tested enforcement on your Kubernetes cluster.</p>

<hr />


<footer class="footline">
	
</footer>

        
            </div> 
        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/010_intro/6_visandmon.html" title="Learn KOP - Part 6 - Visibility and Monitoring"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/010_intro/8_deprov.html" title="Learn KOP - Deprovision Cluster" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1639173650"></script>
    <script src="/js/perfect-scrollbar.min.js?1639173650"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1639173650"></script>
    <script src="/js/jquery.sticky.js?1639173650"></script>
    <script src="/js/featherlight.min.js?1639173650"></script>
    <script src="/js/highlight.pack.js?1639173650"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1639173650"></script>
    <script src="/js/learn.js?1639173650"></script>
    <script src="/js/hugo-learn.js?1639173650"></script>
    
        
            <script src="/mermaid/mermaid.js?1639173650"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

